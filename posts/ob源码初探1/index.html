<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Ob源码初探（1） | 凝紫暮</title><meta name=keywords content><meta name=description content="OceanBase 源码导读路线：从启动、协议、SQL 到存储
一、整体地图（建议先扫一遍目录）

进程与服务：src/observer/main.cpp:687，src/observer/main.cpp:503，src/observer/ob_server.cpp:234，src/observer/ob_server.cpp:931
网络与协议：src/observer/ob_srv_network_frame.h:38，src/observer/ob_srv_deliver.h:42，src/observer/mysql/obsm_handler.cpp:36
MySQL 请求处理：src/observer/mysql/obmp_query.cpp:53
SQL 引擎入口：src/sql/ob_sql.cpp:154（stmt_query），src/sql/ob_sql.cpp:2799（handle_text_query）
解析器与语义：src/sql/parser/ob_parser.cpp:24，src/sql/resolver/ob_resolver.cpp:13
优化与代码生成：src/sql/optimizer/ob_optimizer.cpp:27，src/sql/code_generator/ob_code_generator.cpp:23
执行引擎（TSC 示例）：src/sql/engine/table/ob_table_scan_op.cpp:1874，src/sql/engine/table/ob_table_scan_op.cpp:3763
DAS 与路由：src/sql/das/ob_data_access_service.cpp:84，src/share/location_cache/ob_location_service.h:34，src/share/location_cache/ob_location_service.h:69
存储访问：src/storage/access/ob_table_scan_iterator.h:49，src/storage/blocksstable/ob_sstable.h:140，src/storage/memtable/ob_memtable.h:184，src/storage/memtable/mvcc/ob_mvcc_row.h:60
事务与提交：src/sql/ob_sql_trans_control.cpp:121，src/sql/ob_sql_trans_control.cpp:229，src/storage/tx/ob_trans_service.h:94，src/logservice/ob_log_service.h:94
元数据与多租户：src/share/schema/ob_multi_version_schema_service.h:113，src/share/ob_tenant_mgr.h:1，src/observer/omt/ob_multi_tenant.h:1

二、从进程启动到对外服务

入口与栈切换


main：src/observer/main.cpp:687 → 调用 CALL_WITH_NEW_STACK(inner_main, ...)
inner_main：src/observer/main.cpp:503 完成信号栈、日志、参数解析，构造并驱动 ObServer


Server 初始化与启动


ObServer::init：src/observer/ob_server.cpp:234

关键初始化顺序（摘取常见关注点）：配置→计时器→日志→SQL 静态变量→全局上下文（GCTX）→模式版本→SQL Proxy→IO→KVCache→Schema→网络→RootService→SQL/PL→位置服务→存储→事务时间戳管理等。


ObServer::start：src/observer/ob_server.cpp:931 启动信号线程与各子系统，observer 对外可用。

三、网络与协议层

网络框架与交付


ObSrvNetworkFrame：src/observer/ob_srv_network_frame.h:38 负责 easy 网络、RPC 和 MySQL NIO 的初始化与启动。
ObSrvDeliver：src/observer/ob_srv_deliver.h:42 将请求分发到对应队列/线程组（RPC/MySQL/DDL/诊断等）。


MySQL 握手与连接管理


ObSMHandler：src/observer/mysql/obsm_handler.cpp:36 MySQL 协议握手、认证、连接生命周期与加密参数处理。

四、一次 SQL（以 MySQL 文本查询为例）

协议层入口


ObMPQuery::process()：src/observer/mysql/obmp_query.cpp:53

取会话/租户→限流检查→解析 extra info 与 trace→初始化 schema_guard_ 与本地/全局 schema 版本→调用 SQL 引擎：
gctx_.sql_engine_->stmt_query(sql, ctx_, result)：src/observer/mysql/obmp_query.cpp:1090




SQL 引擎主流程


ObSql::stmt_query()：src/sql/ob_sql.cpp:154

初始化 ResultSet→handle_text_query()：src/sql/ob_sql.cpp:2799
处理 CCL、Plan Cache 命中→进入编译（未命中时）→设置结果集等。




解析与语义


预解析/快速判断：ObParser 构造与 is_pl_stmt() 等：src/sql/parser/ob_parser.cpp:24
语法解析（lexer/yacc 生成文件在 src/sql/parser 目录下，sql_parser_mysql_mode_*.c）
语义解析入口：src/sql/resolver/ob_resolver.cpp:13（按语句类型分发到 DML/DDL/TCL/Prepare 等具体 resolver）


规则改写与优化


规则改写：src/sql/rewrite/ob_transformer_impl.cpp:15 汇聚常见改写（子查询上提、join 消除、谓词下推等）。
基本优化入口：ObOptimizer::optimize()：src/sql/optimizer/ob_optimizer.cpp:27

生成逻辑计划、访问路径选择、代价估计、分布式执行信息等。




代码生成与物理计划


ObCodeGenerator::generate()：src/sql/code_generator/ob_code_generator.cpp:23

生成表达式帧→算子树（静态引擎）→设置 batch/vectorize 相关信息。



五、执行引擎到数据访问（DAS）"><meta name=author content><link rel=canonical href=https://zamaoxiaoji.github.io/posts/ob%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A21/><link crossorigin=anonymous href=/assets/css/stylesheet.2211ca3164be7830024f6aad2b3a2e520843a64f8f048445c3401c1249aa051d.css integrity="sha256-IhHKMWS+eDACT2qtKzouUghDpk+PBIRFw0AcEkmqBR0=" rel="preload stylesheet" as=style><link rel=icon href=https://zamaoxiaoji.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://zamaoxiaoji.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://zamaoxiaoji.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://zamaoxiaoji.github.io/apple-touch-icon.png><link rel=mask-icon href=https://zamaoxiaoji.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://zamaoxiaoji.github.io/posts/ob%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A21/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://zamaoxiaoji.github.io/posts/ob%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A21/"><meta property="og:site_name" content="凝紫暮"><meta property="og:title" content="Ob源码初探（1）"><meta property="og:description" content="OceanBase 源码导读路线：从启动、协议、SQL 到存储
一、整体地图（建议先扫一遍目录）
进程与服务：src/observer/main.cpp:687，src/observer/main.cpp:503，src/observer/ob_server.cpp:234，src/observer/ob_server.cpp:931 网络与协议：src/observer/ob_srv_network_frame.h:38，src/observer/ob_srv_deliver.h:42，src/observer/mysql/obsm_handler.cpp:36 MySQL 请求处理：src/observer/mysql/obmp_query.cpp:53 SQL 引擎入口：src/sql/ob_sql.cpp:154（stmt_query），src/sql/ob_sql.cpp:2799（handle_text_query） 解析器与语义：src/sql/parser/ob_parser.cpp:24，src/sql/resolver/ob_resolver.cpp:13 优化与代码生成：src/sql/optimizer/ob_optimizer.cpp:27，src/sql/code_generator/ob_code_generator.cpp:23 执行引擎（TSC 示例）：src/sql/engine/table/ob_table_scan_op.cpp:1874，src/sql/engine/table/ob_table_scan_op.cpp:3763 DAS 与路由：src/sql/das/ob_data_access_service.cpp:84，src/share/location_cache/ob_location_service.h:34，src/share/location_cache/ob_location_service.h:69 存储访问：src/storage/access/ob_table_scan_iterator.h:49，src/storage/blocksstable/ob_sstable.h:140，src/storage/memtable/ob_memtable.h:184，src/storage/memtable/mvcc/ob_mvcc_row.h:60 事务与提交：src/sql/ob_sql_trans_control.cpp:121，src/sql/ob_sql_trans_control.cpp:229，src/storage/tx/ob_trans_service.h:94，src/logservice/ob_log_service.h:94 元数据与多租户：src/share/schema/ob_multi_version_schema_service.h:113，src/share/ob_tenant_mgr.h:1，src/observer/omt/ob_multi_tenant.h:1 二、从进程启动到对外服务
入口与栈切换 main：src/observer/main.cpp:687 → 调用 CALL_WITH_NEW_STACK(inner_main, ...) inner_main：src/observer/main.cpp:503 完成信号栈、日志、参数解析，构造并驱动 ObServer Server 初始化与启动 ObServer::init：src/observer/ob_server.cpp:234 关键初始化顺序（摘取常见关注点）：配置→计时器→日志→SQL 静态变量→全局上下文（GCTX）→模式版本→SQL Proxy→IO→KVCache→Schema→网络→RootService→SQL/PL→位置服务→存储→事务时间戳管理等。 ObServer::start：src/observer/ob_server.cpp:931 启动信号线程与各子系统，observer 对外可用。 三、网络与协议层
网络框架与交付 ObSrvNetworkFrame：src/observer/ob_srv_network_frame.h:38 负责 easy 网络、RPC 和 MySQL NIO 的初始化与启动。 ObSrvDeliver：src/observer/ob_srv_deliver.h:42 将请求分发到对应队列/线程组（RPC/MySQL/DDL/诊断等）。 MySQL 握手与连接管理 ObSMHandler：src/observer/mysql/obsm_handler.cpp:36 MySQL 协议握手、认证、连接生命周期与加密参数处理。 四、一次 SQL（以 MySQL 文本查询为例）
协议层入口 ObMPQuery::process()：src/observer/mysql/obmp_query.cpp:53 取会话/租户→限流检查→解析 extra info 与 trace→初始化 schema_guard_ 与本地/全局 schema 版本→调用 SQL 引擎： gctx_.sql_engine_->stmt_query(sql, ctx_, result)：src/observer/mysql/obmp_query.cpp:1090 SQL 引擎主流程 ObSql::stmt_query()：src/sql/ob_sql.cpp:154 初始化 ResultSet→handle_text_query()：src/sql/ob_sql.cpp:2799 处理 CCL、Plan Cache 命中→进入编译（未命中时）→设置结果集等。 解析与语义 预解析/快速判断：ObParser 构造与 is_pl_stmt() 等：src/sql/parser/ob_parser.cpp:24 语法解析（lexer/yacc 生成文件在 src/sql/parser 目录下，sql_parser_mysql_mode_*.c） 语义解析入口：src/sql/resolver/ob_resolver.cpp:13（按语句类型分发到 DML/DDL/TCL/Prepare 等具体 resolver） 规则改写与优化 规则改写：src/sql/rewrite/ob_transformer_impl.cpp:15 汇聚常见改写（子查询上提、join 消除、谓词下推等）。 基本优化入口：ObOptimizer::optimize()：src/sql/optimizer/ob_optimizer.cpp:27 生成逻辑计划、访问路径选择、代价估计、分布式执行信息等。 代码生成与物理计划 ObCodeGenerator::generate()：src/sql/code_generator/ob_code_generator.cpp:23 生成表达式帧→算子树（静态引擎）→设置 batch/vectorize 相关信息。 五、执行引擎到数据访问（DAS）"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-11-05T11:08:04+08:00"><meta property="article:modified_time" content="2025-11-05T11:08:04+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Ob源码初探（1）"><meta name=twitter:description content="OceanBase 源码导读路线：从启动、协议、SQL 到存储
一、整体地图（建议先扫一遍目录）

进程与服务：src/observer/main.cpp:687，src/observer/main.cpp:503，src/observer/ob_server.cpp:234，src/observer/ob_server.cpp:931
网络与协议：src/observer/ob_srv_network_frame.h:38，src/observer/ob_srv_deliver.h:42，src/observer/mysql/obsm_handler.cpp:36
MySQL 请求处理：src/observer/mysql/obmp_query.cpp:53
SQL 引擎入口：src/sql/ob_sql.cpp:154（stmt_query），src/sql/ob_sql.cpp:2799（handle_text_query）
解析器与语义：src/sql/parser/ob_parser.cpp:24，src/sql/resolver/ob_resolver.cpp:13
优化与代码生成：src/sql/optimizer/ob_optimizer.cpp:27，src/sql/code_generator/ob_code_generator.cpp:23
执行引擎（TSC 示例）：src/sql/engine/table/ob_table_scan_op.cpp:1874，src/sql/engine/table/ob_table_scan_op.cpp:3763
DAS 与路由：src/sql/das/ob_data_access_service.cpp:84，src/share/location_cache/ob_location_service.h:34，src/share/location_cache/ob_location_service.h:69
存储访问：src/storage/access/ob_table_scan_iterator.h:49，src/storage/blocksstable/ob_sstable.h:140，src/storage/memtable/ob_memtable.h:184，src/storage/memtable/mvcc/ob_mvcc_row.h:60
事务与提交：src/sql/ob_sql_trans_control.cpp:121，src/sql/ob_sql_trans_control.cpp:229，src/storage/tx/ob_trans_service.h:94，src/logservice/ob_log_service.h:94
元数据与多租户：src/share/schema/ob_multi_version_schema_service.h:113，src/share/ob_tenant_mgr.h:1，src/observer/omt/ob_multi_tenant.h:1

二、从进程启动到对外服务

入口与栈切换


main：src/observer/main.cpp:687 → 调用 CALL_WITH_NEW_STACK(inner_main, ...)
inner_main：src/observer/main.cpp:503 完成信号栈、日志、参数解析，构造并驱动 ObServer


Server 初始化与启动


ObServer::init：src/observer/ob_server.cpp:234

关键初始化顺序（摘取常见关注点）：配置→计时器→日志→SQL 静态变量→全局上下文（GCTX）→模式版本→SQL Proxy→IO→KVCache→Schema→网络→RootService→SQL/PL→位置服务→存储→事务时间戳管理等。


ObServer::start：src/observer/ob_server.cpp:931 启动信号线程与各子系统，observer 对外可用。

三、网络与协议层

网络框架与交付


ObSrvNetworkFrame：src/observer/ob_srv_network_frame.h:38 负责 easy 网络、RPC 和 MySQL NIO 的初始化与启动。
ObSrvDeliver：src/observer/ob_srv_deliver.h:42 将请求分发到对应队列/线程组（RPC/MySQL/DDL/诊断等）。


MySQL 握手与连接管理


ObSMHandler：src/observer/mysql/obsm_handler.cpp:36 MySQL 协议握手、认证、连接生命周期与加密参数处理。

四、一次 SQL（以 MySQL 文本查询为例）

协议层入口


ObMPQuery::process()：src/observer/mysql/obmp_query.cpp:53

取会话/租户→限流检查→解析 extra info 与 trace→初始化 schema_guard_ 与本地/全局 schema 版本→调用 SQL 引擎：
gctx_.sql_engine_->stmt_query(sql, ctx_, result)：src/observer/mysql/obmp_query.cpp:1090




SQL 引擎主流程


ObSql::stmt_query()：src/sql/ob_sql.cpp:154

初始化 ResultSet→handle_text_query()：src/sql/ob_sql.cpp:2799
处理 CCL、Plan Cache 命中→进入编译（未命中时）→设置结果集等。




解析与语义


预解析/快速判断：ObParser 构造与 is_pl_stmt() 等：src/sql/parser/ob_parser.cpp:24
语法解析（lexer/yacc 生成文件在 src/sql/parser 目录下，sql_parser_mysql_mode_*.c）
语义解析入口：src/sql/resolver/ob_resolver.cpp:13（按语句类型分发到 DML/DDL/TCL/Prepare 等具体 resolver）


规则改写与优化


规则改写：src/sql/rewrite/ob_transformer_impl.cpp:15 汇聚常见改写（子查询上提、join 消除、谓词下推等）。
基本优化入口：ObOptimizer::optimize()：src/sql/optimizer/ob_optimizer.cpp:27

生成逻辑计划、访问路径选择、代价估计、分布式执行信息等。




代码生成与物理计划


ObCodeGenerator::generate()：src/sql/code_generator/ob_code_generator.cpp:23

生成表达式帧→算子树（静态引擎）→设置 batch/vectorize 相关信息。



五、执行引擎到数据访问（DAS）"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://zamaoxiaoji.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Ob源码初探（1）","item":"https://zamaoxiaoji.github.io/posts/ob%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A21/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Ob源码初探（1）","name":"Ob源码初探（1）","description":"OceanBase 源码导读路线：从启动、协议、SQL 到存储\n一、整体地图（建议先扫一遍目录）\n进程与服务：src/observer/main.cpp:687，src/observer/main.cpp:503，src/observer/ob_server.cpp:234，src/observer/ob_server.cpp:931 网络与协议：src/observer/ob_srv_network_frame.h:38，src/observer/ob_srv_deliver.h:42，src/observer/mysql/obsm_handler.cpp:36 MySQL 请求处理：src/observer/mysql/obmp_query.cpp:53 SQL 引擎入口：src/sql/ob_sql.cpp:154（stmt_query），src/sql/ob_sql.cpp:2799（handle_text_query） 解析器与语义：src/sql/parser/ob_parser.cpp:24，src/sql/resolver/ob_resolver.cpp:13 优化与代码生成：src/sql/optimizer/ob_optimizer.cpp:27，src/sql/code_generator/ob_code_generator.cpp:23 执行引擎（TSC 示例）：src/sql/engine/table/ob_table_scan_op.cpp:1874，src/sql/engine/table/ob_table_scan_op.cpp:3763 DAS 与路由：src/sql/das/ob_data_access_service.cpp:84，src/share/location_cache/ob_location_service.h:34，src/share/location_cache/ob_location_service.h:69 存储访问：src/storage/access/ob_table_scan_iterator.h:49，src/storage/blocksstable/ob_sstable.h:140，src/storage/memtable/ob_memtable.h:184，src/storage/memtable/mvcc/ob_mvcc_row.h:60 事务与提交：src/sql/ob_sql_trans_control.cpp:121，src/sql/ob_sql_trans_control.cpp:229，src/storage/tx/ob_trans_service.h:94，src/logservice/ob_log_service.h:94 元数据与多租户：src/share/schema/ob_multi_version_schema_service.h:113，src/share/ob_tenant_mgr.h:1，src/observer/omt/ob_multi_tenant.h:1 二、从进程启动到对外服务\n入口与栈切换 main：src/observer/main.cpp:687 → 调用 CALL_WITH_NEW_STACK(inner_main, ...) inner_main：src/observer/main.cpp:503 完成信号栈、日志、参数解析，构造并驱动 ObServer Server 初始化与启动 ObServer::init：src/observer/ob_server.cpp:234 关键初始化顺序（摘取常见关注点）：配置→计时器→日志→SQL 静态变量→全局上下文（GCTX）→模式版本→SQL Proxy→IO→KVCache→Schema→网络→RootService→SQL/PL→位置服务→存储→事务时间戳管理等。 ObServer::start：src/observer/ob_server.cpp:931 启动信号线程与各子系统，observer 对外可用。 三、网络与协议层\n网络框架与交付 ObSrvNetworkFrame：src/observer/ob_srv_network_frame.h:38 负责 easy 网络、RPC 和 MySQL NIO 的初始化与启动。 ObSrvDeliver：src/observer/ob_srv_deliver.h:42 将请求分发到对应队列/线程组（RPC/MySQL/DDL/诊断等）。 MySQL 握手与连接管理 ObSMHandler：src/observer/mysql/obsm_handler.cpp:36 MySQL 协议握手、认证、连接生命周期与加密参数处理。 四、一次 SQL（以 MySQL 文本查询为例）\n协议层入口 ObMPQuery::process()：src/observer/mysql/obmp_query.cpp:53 取会话/租户→限流检查→解析 extra info 与 trace→初始化 schema_guard_ 与本地/全局 schema 版本→调用 SQL 引擎： gctx_.sql_engine_-\u0026gt;stmt_query(sql, ctx_, result)：src/observer/mysql/obmp_query.cpp:1090 SQL 引擎主流程 ObSql::stmt_query()：src/sql/ob_sql.cpp:154 初始化 ResultSet→handle_text_query()：src/sql/ob_sql.cpp:2799 处理 CCL、Plan Cache 命中→进入编译（未命中时）→设置结果集等。 解析与语义 预解析/快速判断：ObParser 构造与 is_pl_stmt() 等：src/sql/parser/ob_parser.cpp:24 语法解析（lexer/yacc 生成文件在 src/sql/parser 目录下，sql_parser_mysql_mode_*.c） 语义解析入口：src/sql/resolver/ob_resolver.cpp:13（按语句类型分发到 DML/DDL/TCL/Prepare 等具体 resolver） 规则改写与优化 规则改写：src/sql/rewrite/ob_transformer_impl.cpp:15 汇聚常见改写（子查询上提、join 消除、谓词下推等）。 基本优化入口：ObOptimizer::optimize()：src/sql/optimizer/ob_optimizer.cpp:27 生成逻辑计划、访问路径选择、代价估计、分布式执行信息等。 代码生成与物理计划 ObCodeGenerator::generate()：src/sql/code_generator/ob_code_generator.cpp:23 生成表达式帧→算子树（静态引擎）→设置 batch/vectorize 相关信息。 五、执行引擎到数据访问（DAS）\n","keywords":[],"articleBody":"OceanBase 源码导读路线：从启动、协议、SQL 到存储\n一、整体地图（建议先扫一遍目录）\n进程与服务：src/observer/main.cpp:687，src/observer/main.cpp:503，src/observer/ob_server.cpp:234，src/observer/ob_server.cpp:931 网络与协议：src/observer/ob_srv_network_frame.h:38，src/observer/ob_srv_deliver.h:42，src/observer/mysql/obsm_handler.cpp:36 MySQL 请求处理：src/observer/mysql/obmp_query.cpp:53 SQL 引擎入口：src/sql/ob_sql.cpp:154（stmt_query），src/sql/ob_sql.cpp:2799（handle_text_query） 解析器与语义：src/sql/parser/ob_parser.cpp:24，src/sql/resolver/ob_resolver.cpp:13 优化与代码生成：src/sql/optimizer/ob_optimizer.cpp:27，src/sql/code_generator/ob_code_generator.cpp:23 执行引擎（TSC 示例）：src/sql/engine/table/ob_table_scan_op.cpp:1874，src/sql/engine/table/ob_table_scan_op.cpp:3763 DAS 与路由：src/sql/das/ob_data_access_service.cpp:84，src/share/location_cache/ob_location_service.h:34，src/share/location_cache/ob_location_service.h:69 存储访问：src/storage/access/ob_table_scan_iterator.h:49，src/storage/blocksstable/ob_sstable.h:140，src/storage/memtable/ob_memtable.h:184，src/storage/memtable/mvcc/ob_mvcc_row.h:60 事务与提交：src/sql/ob_sql_trans_control.cpp:121，src/sql/ob_sql_trans_control.cpp:229，src/storage/tx/ob_trans_service.h:94，src/logservice/ob_log_service.h:94 元数据与多租户：src/share/schema/ob_multi_version_schema_service.h:113，src/share/ob_tenant_mgr.h:1，src/observer/omt/ob_multi_tenant.h:1 二、从进程启动到对外服务\n入口与栈切换 main：src/observer/main.cpp:687 → 调用 CALL_WITH_NEW_STACK(inner_main, ...) inner_main：src/observer/main.cpp:503 完成信号栈、日志、参数解析，构造并驱动 ObServer Server 初始化与启动 ObServer::init：src/observer/ob_server.cpp:234 关键初始化顺序（摘取常见关注点）：配置→计时器→日志→SQL 静态变量→全局上下文（GCTX）→模式版本→SQL Proxy→IO→KVCache→Schema→网络→RootService→SQL/PL→位置服务→存储→事务时间戳管理等。 ObServer::start：src/observer/ob_server.cpp:931 启动信号线程与各子系统，observer 对外可用。 三、网络与协议层\n网络框架与交付 ObSrvNetworkFrame：src/observer/ob_srv_network_frame.h:38 负责 easy 网络、RPC 和 MySQL NIO 的初始化与启动。 ObSrvDeliver：src/observer/ob_srv_deliver.h:42 将请求分发到对应队列/线程组（RPC/MySQL/DDL/诊断等）。 MySQL 握手与连接管理 ObSMHandler：src/observer/mysql/obsm_handler.cpp:36 MySQL 协议握手、认证、连接生命周期与加密参数处理。 四、一次 SQL（以 MySQL 文本查询为例）\n协议层入口 ObMPQuery::process()：src/observer/mysql/obmp_query.cpp:53 取会话/租户→限流检查→解析 extra info 与 trace→初始化 schema_guard_ 与本地/全局 schema 版本→调用 SQL 引擎： gctx_.sql_engine_-\u003estmt_query(sql, ctx_, result)：src/observer/mysql/obmp_query.cpp:1090 SQL 引擎主流程 ObSql::stmt_query()：src/sql/ob_sql.cpp:154 初始化 ResultSet→handle_text_query()：src/sql/ob_sql.cpp:2799 处理 CCL、Plan Cache 命中→进入编译（未命中时）→设置结果集等。 解析与语义 预解析/快速判断：ObParser 构造与 is_pl_stmt() 等：src/sql/parser/ob_parser.cpp:24 语法解析（lexer/yacc 生成文件在 src/sql/parser 目录下，sql_parser_mysql_mode_*.c） 语义解析入口：src/sql/resolver/ob_resolver.cpp:13（按语句类型分发到 DML/DDL/TCL/Prepare 等具体 resolver） 规则改写与优化 规则改写：src/sql/rewrite/ob_transformer_impl.cpp:15 汇聚常见改写（子查询上提、join 消除、谓词下推等）。 基本优化入口：ObOptimizer::optimize()：src/sql/optimizer/ob_optimizer.cpp:27 生成逻辑计划、访问路径选择、代价估计、分布式执行信息等。 代码生成与物理计划 ObCodeGenerator::generate()：src/sql/code_generator/ob_code_generator.cpp:23 生成表达式帧→算子树（静态引擎）→设置 batch/vectorize 相关信息。 五、执行引擎到数据访问（DAS）\n表扫描算子（TSC）为例 算子实现（获取下一行/批）： ObTableScanOp::inner_open()：src/sql/engine/table/ob_table_scan_op.cpp:1874 ObTableScanOp::inner_get_next_row()：src/sql/engine/table/ob_table_scan_op.cpp:3763 关键运行时定义（RTD/CTD）、Range 构造、BNLJ 参数、Runtime Filter 等在该文件分散实现，可结合 init_table_scan_rtdef()、prepare_scan_range() 搜索阅读。 DAS 分发与本地/远程执行 ObDataAccessService::execute_das_task()：src/sql/das/ob_data_access_service.cpp:84 本地直接执行任务，或通过 RPC 将子任务下发到目标节点； 结合 get_das_task_id()、execute_dist_das_task() 理解并发与回包管理。 位置服务（定位 LS/Tablet Leader）： ObLocationService::get_leader()：src/share/location_cache/ob_location_service.h:69 六、存储层：从 Tablet 到 Memtable/SSTable\nTablet 与 LS ObLS（日志流）承载一组 Tablet：src/storage/ls/ob_ls.h:196 ObTablet（表/分区最小管理单元）：src/storage/tablet/ob_tablet.h:154 访问路径与合并迭代 统一扫描迭代器：ObTableScanIterator：src/storage/access/ob_table_scan_iterator.h:49 负责组织 Memtable 与多层 SSTable 的多路归并，构造 ObTableAccessParam/Context，open_iter() 打开各层迭代器。 Memtable（内存多版本） Memtable 类：src/storage/memtable/ob_memtable.h:184 MVCC 版本链节点：ObMvccTransNode：src/storage/memtable/mvcc/ob_mvcc_row.h:60 字段含义：tx_id_、trans_version_（可见性）、scn_、seq_no_、prev_/next_ 等；理解读写冲突、提交可见性与快照读需从这里入手。 SSTable（磁盘有序表） 统一只读接口：ObSSTable：src/storage/blocksstable/ob_sstable.h:140 scan/get/multi_scan/multi_get 四组接口； 宏/微块索引、BloomFilter、二级元数据扫描等接口在同文件继续向下； 结合 blocksstable/index_block/* 观察索引组织与“先索引后数据”的 IO 流程。 七、事务融入执行\n语句级/事务级控制 显式开启：ObSqlTransControl::explicit_start_trans()：src/sql/ob_sql_trans_control.cpp:121，src/sql/ob_sql_trans_control.cpp:138 结束（提交/回滚）：ObSqlTransControl::end_trans()：src/sql/ob_sql_trans_control.cpp:229 关键服务：ObTransService：src/storage/tx/ob_trans_service.h:94 日志提交与复制 ObLogService：src/logservice/ob_log_service.h:94 提供提交/回放对接（底层封装 Palf），事务提交走 Redo→Prepare→Commit（两阶段/ELR）到位后可见。 八、Schema 与缓存\n多版本 Schema 服务：ObMultiVersionSchemaService：src/share/schema/ob_multi_version_schema_service.h:113 提供 get_tenant_schema_guard() 获取指定租户与版本的元数据视图，ObMPQuery 里会设置租户/系统两套版本参与重试控制。 计划缓存绑定 Schema 版本（见 ObSql::handle_text_query()：src/sql/ob_sql.cpp:2799 中 plan cache 逻辑），发生切主/变更可能触发重编译。 九、推荐阅读路径与断点 Step 0（运行/attach）：启动 observer 后，用 gdb/lldb 设断点并 attach 到进程。\nStep 1（启动期）\n断点：src/observer/main.cpp:503，src/observer/ob_server.cpp:234，src/observer/ob_server.cpp:931 关注：配置装载、网络启动、GCTX 填充。 Step 2（协议接入）\n断点：src/observer/mysql/obsm_handler.cpp:69（on_connect），src/observer/mysql/obmp_query.cpp:53 关注：连接态、租户/会话、trace_id 与超时设置。 Step 3（编译链）\n断点：src/sql/ob_sql.cpp:154，src/sql/ob_sql.cpp:2799，src/sql/parser/ob_parser.cpp:24，src/sql/resolver/ob_resolver.cpp:13，src/sql/rewrite/ob_transformer_impl.cpp:15，src/sql/optimizer/ob_optimizer.cpp:27，src/sql/code_generator/ob_code_generator.cpp:23 关注：Plan Cache 命中/失效、AST→逻辑计划→物理计划各阶段输入输出。 Step 4（执行与存储）\n断点：src/sql/engine/table/ob_table_scan_op.cpp:1874，src/sql/engine/table/ob_table_scan_op.cpp:3763，src/sql/das/ob_data_access_service.cpp:84，src/share/location_cache/ob_location_service.h:69，src/storage/access/ob_table_scan_iterator.h:49，src/storage/blocksstable/ob_sstable.h:140 关注：DAS 本地/远程、LS/Tablet 定位、Memtable/SSTable 归并读取。 Step 5（事务与提交）\n断点：src/sql/ob_sql_trans_control.cpp:121，src/sql/ob_sql_trans_control.cpp:229，src/storage/tx/ob_trans_service.h:94，src/logservice/ob_log_service.h:94 关注：显式/隐式事务、autocommit、提交路径与可见性。 十、按主题的深入清单（可分支阅读）\n执行引擎（静态向量化）：src/sql/code_generator/ob_static_engine_cg.cpp:1，src/sql/engine/expr/*（表达式计算与向量化批处理） PX 与并行：src/sql/engine/px/*（GI/GI task 切分、DFO 调度、Exchange） Compaction：src/storage/compaction/*（合并策略、Medium Info、Builder） LOB/外表：src/storage/lob/*，src/sql/engine/table/*external*（外部格式访问） 权限与审计：src/sql/privilege_check/*，src/sql/monitor/ob_security_audit_utils.h:1 十一、常见阅读技巧\nripgrep 搜索调用链：rg -n \"ObTableScanOp::inner_get_next_row|execute_das_task|ob_sstable\" 定位热路径。 打印 trace_id：在 ObMPQuery::process 与 ObSql::stmt_query 附近观察 ObCurTraceId 与 FLT 标签。 查看 Schema 版本：ObMPQuery::process 中 retry_ctrl_ 的本地/全局版本设置。 附：一次 SELECT 简化调用图（关键节点）\nMySQL 收包 → ObMPQuery::process（src/observer/mysql/obmp_query.cpp:53） → SQL 引擎 ObSql::stmt_query（src/sql/ob_sql.cpp:154）/handle_text_query（2799） → 解析（src/sql/parser/ob_parser.cpp:24）→ 语义（src/sql/resolver/ob_resolver.cpp:13）→ 改写（src/sql/rewrite/ob_transformer_impl.cpp:15）→ 优化（src/sql/optimizer/ob_optimizer.cpp:27）→ 代码生成（src/sql/code_generator/ob_code_generator.cpp:23） → 执行（ObTableScanOp::inner_open/get_next_row） → DAS（execute_das_task）→ 位置服务（get_leader）→ 存储访问（ObTableScanIterator→ObMemtable/ObSSTable） → 返回结果集并编码为 MySQL 包。 说明\n文中行号为便于设断点的“函数起始附近”位置，随版本可能轻微偏移；若不匹配，可先 rg 搜索函数名再下断点。 ","wordCount":"296","inLanguage":"en","datePublished":"2025-11-05T11:08:04+08:00","dateModified":"2025-11-05T11:08:04+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://zamaoxiaoji.github.io/posts/ob%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A21/"},"publisher":{"@type":"Organization","name":"凝紫暮","logo":{"@type":"ImageObject","url":"https://zamaoxiaoji.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://zamaoxiaoji.github.io/ accesskey=h title="凝紫暮 (Alt + H)">凝紫暮</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Ob源码初探（1）</h1><div class=post-meta><span title='2025-11-05 11:08:04 +0800 +0800'>November 5, 2025</span></div></header><div class=post-content><p>OceanBase 源码导读路线：从启动、协议、SQL 到存储</p><p>一、整体地图（建议先扫一遍目录）</p><ul><li>进程与服务：<code>src/observer/main.cpp:687</code>，<code>src/observer/main.cpp:503</code>，<code>src/observer/ob_server.cpp:234</code>，<code>src/observer/ob_server.cpp:931</code></li><li>网络与协议：<code>src/observer/ob_srv_network_frame.h:38</code>，<code>src/observer/ob_srv_deliver.h:42</code>，<code>src/observer/mysql/obsm_handler.cpp:36</code></li><li>MySQL 请求处理：<code>src/observer/mysql/obmp_query.cpp:53</code></li><li>SQL 引擎入口：<code>src/sql/ob_sql.cpp:154</code>（<code>stmt_query</code>），<code>src/sql/ob_sql.cpp:2799</code>（<code>handle_text_query</code>）</li><li>解析器与语义：<code>src/sql/parser/ob_parser.cpp:24</code>，<code>src/sql/resolver/ob_resolver.cpp:13</code></li><li>优化与代码生成：<code>src/sql/optimizer/ob_optimizer.cpp:27</code>，<code>src/sql/code_generator/ob_code_generator.cpp:23</code></li><li>执行引擎（TSC 示例）：<code>src/sql/engine/table/ob_table_scan_op.cpp:1874</code>，<code>src/sql/engine/table/ob_table_scan_op.cpp:3763</code></li><li>DAS 与路由：<code>src/sql/das/ob_data_access_service.cpp:84</code>，<code>src/share/location_cache/ob_location_service.h:34</code>，<code>src/share/location_cache/ob_location_service.h:69</code></li><li>存储访问：<code>src/storage/access/ob_table_scan_iterator.h:49</code>，<code>src/storage/blocksstable/ob_sstable.h:140</code>，<code>src/storage/memtable/ob_memtable.h:184</code>，<code>src/storage/memtable/mvcc/ob_mvcc_row.h:60</code></li><li>事务与提交：<code>src/sql/ob_sql_trans_control.cpp:121</code>，<code>src/sql/ob_sql_trans_control.cpp:229</code>，<code>src/storage/tx/ob_trans_service.h:94</code>，<code>src/logservice/ob_log_service.h:94</code></li><li>元数据与多租户：<code>src/share/schema/ob_multi_version_schema_service.h:113</code>，<code>src/share/ob_tenant_mgr.h:1</code>，<code>src/observer/omt/ob_multi_tenant.h:1</code></li></ul><p>二、从进程启动到对外服务</p><ol><li>入口与栈切换</li></ol><ul><li><code>main</code>：<code>src/observer/main.cpp:687</code> → 调用 <code>CALL_WITH_NEW_STACK(inner_main, ...)</code></li><li><code>inner_main</code>：<code>src/observer/main.cpp:503</code> 完成信号栈、日志、参数解析，构造并驱动 <code>ObServer</code></li></ul><ol start=2><li>Server 初始化与启动</li></ol><ul><li><code>ObServer::init</code>：<code>src/observer/ob_server.cpp:234</code><ul><li>关键初始化顺序（摘取常见关注点）：配置→计时器→日志→SQL 静态变量→全局上下文（<code>GCTX</code>）→模式版本→SQL Proxy→IO→KVCache→Schema→网络→RootService→SQL/PL→位置服务→存储→事务时间戳管理等。</li></ul></li><li><code>ObServer::start</code>：<code>src/observer/ob_server.cpp:931</code> 启动信号线程与各子系统，observer 对外可用。</li></ul><p>三、网络与协议层</p><ol><li>网络框架与交付</li></ol><ul><li><code>ObSrvNetworkFrame</code>：<code>src/observer/ob_srv_network_frame.h:38</code> 负责 easy 网络、RPC 和 MySQL NIO 的初始化与启动。</li><li><code>ObSrvDeliver</code>：<code>src/observer/ob_srv_deliver.h:42</code> 将请求分发到对应队列/线程组（RPC/MySQL/DDL/诊断等）。</li></ul><ol start=2><li>MySQL 握手与连接管理</li></ol><ul><li><code>ObSMHandler</code>：<code>src/observer/mysql/obsm_handler.cpp:36</code> MySQL 协议握手、认证、连接生命周期与加密参数处理。</li></ul><p>四、一次 SQL（以 MySQL 文本查询为例）</p><ol><li>协议层入口</li></ol><ul><li><code>ObMPQuery::process()</code>：<code>src/observer/mysql/obmp_query.cpp:53</code><ul><li>取会话/租户→限流检查→解析 extra info 与 trace→初始化 <code>schema_guard_</code> 与本地/全局 schema 版本→调用 SQL 引擎：</li><li><code>gctx_.sql_engine_->stmt_query(sql, ctx_, result)</code>：<code>src/observer/mysql/obmp_query.cpp:1090</code></li></ul></li></ul><ol start=2><li>SQL 引擎主流程</li></ol><ul><li><code>ObSql::stmt_query()</code>：<code>src/sql/ob_sql.cpp:154</code><ul><li>初始化 <code>ResultSet</code>→<code>handle_text_query()</code>：<code>src/sql/ob_sql.cpp:2799</code></li><li>处理 CCL、Plan Cache 命中→进入编译（未命中时）→设置结果集等。</li></ul></li></ul><ol start=3><li>解析与语义</li></ol><ul><li>预解析/快速判断：<code>ObParser</code> 构造与 <code>is_pl_stmt()</code> 等：<code>src/sql/parser/ob_parser.cpp:24</code></li><li>语法解析（lexer/yacc 生成文件在 <code>src/sql/parser</code> 目录下，<code>sql_parser_mysql_mode_*.c</code>）</li><li>语义解析入口：<code>src/sql/resolver/ob_resolver.cpp:13</code>（按语句类型分发到 DML/DDL/TCL/Prepare 等具体 resolver）</li></ul><ol start=4><li>规则改写与优化</li></ol><ul><li>规则改写：<code>src/sql/rewrite/ob_transformer_impl.cpp:15</code> 汇聚常见改写（子查询上提、join 消除、谓词下推等）。</li><li>基本优化入口：<code>ObOptimizer::optimize()</code>：<code>src/sql/optimizer/ob_optimizer.cpp:27</code><ul><li>生成逻辑计划、访问路径选择、代价估计、分布式执行信息等。</li></ul></li></ul><ol start=5><li>代码生成与物理计划</li></ol><ul><li><code>ObCodeGenerator::generate()</code>：<code>src/sql/code_generator/ob_code_generator.cpp:23</code><ul><li>生成表达式帧→算子树（静态引擎）→设置 batch/vectorize 相关信息。</li></ul></li></ul><p>五、执行引擎到数据访问（DAS）</p><ol><li>表扫描算子（TSC）为例</li></ol><ul><li>算子实现（获取下一行/批）：<ul><li><code>ObTableScanOp::inner_open()</code>：<code>src/sql/engine/table/ob_table_scan_op.cpp:1874</code></li><li><code>ObTableScanOp::inner_get_next_row()</code>：<code>src/sql/engine/table/ob_table_scan_op.cpp:3763</code></li><li>关键运行时定义（RTD/CTD）、Range 构造、BNLJ 参数、Runtime Filter 等在该文件分散实现，可结合 <code>init_table_scan_rtdef()</code>、<code>prepare_scan_range()</code> 搜索阅读。</li></ul></li></ul><ol start=2><li>DAS 分发与本地/远程执行</li></ol><ul><li><code>ObDataAccessService::execute_das_task()</code>：<code>src/sql/das/ob_data_access_service.cpp:84</code><ul><li>本地直接执行任务，或通过 RPC 将子任务下发到目标节点；</li><li>结合 <code>get_das_task_id()</code>、<code>execute_dist_das_task()</code> 理解并发与回包管理。</li></ul></li><li>位置服务（定位 LS/Tablet Leader）：<ul><li><code>ObLocationService::get_leader()</code>：<code>src/share/location_cache/ob_location_service.h:69</code></li></ul></li></ul><p>六、存储层：从 Tablet 到 Memtable/SSTable</p><ol><li>Tablet 与 LS</li></ol><ul><li><code>ObLS</code>（日志流）承载一组 Tablet：<code>src/storage/ls/ob_ls.h:196</code></li><li><code>ObTablet</code>（表/分区最小管理单元）：<code>src/storage/tablet/ob_tablet.h:154</code></li></ul><ol start=2><li>访问路径与合并迭代</li></ol><ul><li>统一扫描迭代器：<code>ObTableScanIterator</code>：<code>src/storage/access/ob_table_scan_iterator.h:49</code><ul><li>负责组织 Memtable 与多层 SSTable 的多路归并，构造 <code>ObTableAccessParam/Context</code>，<code>open_iter()</code> 打开各层迭代器。</li></ul></li></ul><ol start=3><li>Memtable（内存多版本）</li></ol><ul><li>Memtable 类：<code>src/storage/memtable/ob_memtable.h:184</code></li><li>MVCC 版本链节点：<code>ObMvccTransNode</code>：<code>src/storage/memtable/mvcc/ob_mvcc_row.h:60</code><ul><li>字段含义：<code>tx_id_</code>、<code>trans_version_</code>（可见性）、<code>scn_</code>、<code>seq_no_</code>、<code>prev_/next_</code> 等；理解读写冲突、提交可见性与快照读需从这里入手。</li></ul></li></ul><ol start=4><li>SSTable（磁盘有序表）</li></ol><ul><li>统一只读接口：<code>ObSSTable</code>：<code>src/storage/blocksstable/ob_sstable.h:140</code><ul><li><code>scan/get/multi_scan/multi_get</code> 四组接口；</li><li>宏/微块索引、BloomFilter、二级元数据扫描等接口在同文件继续向下；</li><li>结合 <code>blocksstable/index_block/*</code> 观察索引组织与“先索引后数据”的 IO 流程。</li></ul></li></ul><p>七、事务融入执行</p><ol><li>语句级/事务级控制</li></ol><ul><li>显式开启：<code>ObSqlTransControl::explicit_start_trans()</code>：<code>src/sql/ob_sql_trans_control.cpp:121</code>，<code>src/sql/ob_sql_trans_control.cpp:138</code></li><li>结束（提交/回滚）：<code>ObSqlTransControl::end_trans()</code>：<code>src/sql/ob_sql_trans_control.cpp:229</code></li><li>关键服务：<code>ObTransService</code>：<code>src/storage/tx/ob_trans_service.h:94</code></li></ul><ol start=2><li>日志提交与复制</li></ol><ul><li><code>ObLogService</code>：<code>src/logservice/ob_log_service.h:94</code> 提供提交/回放对接（底层封装 Palf），事务提交走 Redo→Prepare→Commit（两阶段/ELR）到位后可见。</li></ul><p>八、Schema 与缓存</p><ul><li>多版本 Schema 服务：<code>ObMultiVersionSchemaService</code>：<code>src/share/schema/ob_multi_version_schema_service.h:113</code><ul><li>提供 <code>get_tenant_schema_guard()</code> 获取指定租户与版本的元数据视图，<code>ObMPQuery</code> 里会设置租户/系统两套版本参与重试控制。</li></ul></li><li>计划缓存绑定 Schema 版本（见 <code>ObSql::handle_text_query()</code>：<code>src/sql/ob_sql.cpp:2799</code> 中 plan cache 逻辑），发生切主/变更可能触发重编译。</li></ul><p>九、推荐阅读路径与断点
Step 0（运行/attach）：启动 observer 后，用 gdb/lldb 设断点并 attach 到进程。</p><p>Step 1（启动期）</p><ul><li>断点：<code>src/observer/main.cpp:503</code>，<code>src/observer/ob_server.cpp:234</code>，<code>src/observer/ob_server.cpp:931</code></li><li>关注：配置装载、网络启动、GCTX 填充。</li></ul><p>Step 2（协议接入）</p><ul><li>断点：<code>src/observer/mysql/obsm_handler.cpp:69</code>（on_connect），<code>src/observer/mysql/obmp_query.cpp:53</code></li><li>关注：连接态、租户/会话、trace_id 与超时设置。</li></ul><p>Step 3（编译链）</p><ul><li>断点：<code>src/sql/ob_sql.cpp:154</code>，<code>src/sql/ob_sql.cpp:2799</code>，<code>src/sql/parser/ob_parser.cpp:24</code>，<code>src/sql/resolver/ob_resolver.cpp:13</code>，<code>src/sql/rewrite/ob_transformer_impl.cpp:15</code>，<code>src/sql/optimizer/ob_optimizer.cpp:27</code>，<code>src/sql/code_generator/ob_code_generator.cpp:23</code></li><li>关注：Plan Cache 命中/失效、AST→逻辑计划→物理计划各阶段输入输出。</li></ul><p>Step 4（执行与存储）</p><ul><li>断点：<code>src/sql/engine/table/ob_table_scan_op.cpp:1874</code>，<code>src/sql/engine/table/ob_table_scan_op.cpp:3763</code>，<code>src/sql/das/ob_data_access_service.cpp:84</code>，<code>src/share/location_cache/ob_location_service.h:69</code>，<code>src/storage/access/ob_table_scan_iterator.h:49</code>，<code>src/storage/blocksstable/ob_sstable.h:140</code></li><li>关注：DAS 本地/远程、LS/Tablet 定位、Memtable/SSTable 归并读取。</li></ul><p>Step 5（事务与提交）</p><ul><li>断点：<code>src/sql/ob_sql_trans_control.cpp:121</code>，<code>src/sql/ob_sql_trans_control.cpp:229</code>，<code>src/storage/tx/ob_trans_service.h:94</code>，<code>src/logservice/ob_log_service.h:94</code></li><li>关注：显式/隐式事务、autocommit、提交路径与可见性。</li></ul><p>十、按主题的深入清单（可分支阅读）</p><ul><li>执行引擎（静态向量化）：<code>src/sql/code_generator/ob_static_engine_cg.cpp:1</code>，<code>src/sql/engine/expr/*</code>（表达式计算与向量化批处理）</li><li>PX 与并行：<code>src/sql/engine/px/*</code>（GI/GI task 切分、DFO 调度、Exchange）</li><li>Compaction：<code>src/storage/compaction/*</code>（合并策略、Medium Info、Builder）</li><li>LOB/外表：<code>src/storage/lob/*</code>，<code>src/sql/engine/table/*external*</code>（外部格式访问）</li><li>权限与审计：<code>src/sql/privilege_check/*</code>，<code>src/sql/monitor/ob_security_audit_utils.h:1</code></li></ul><p>十一、常见阅读技巧</p><ul><li>ripgrep 搜索调用链：<code>rg -n "ObTableScanOp::inner_get_next_row|execute_das_task|ob_sstable"</code> 定位热路径。</li><li>打印 trace_id：在 <code>ObMPQuery::process</code> 与 <code>ObSql::stmt_query</code> 附近观察 <code>ObCurTraceId</code> 与 FLT 标签。</li><li>查看 Schema 版本：<code>ObMPQuery::process</code> 中 <code>retry_ctrl_</code> 的本地/全局版本设置。</li></ul><p>附：一次 SELECT 简化调用图（关键节点）</p><ul><li>MySQL 收包 → <code>ObMPQuery::process</code>（<code>src/observer/mysql/obmp_query.cpp:53</code>）</li><li>→ SQL 引擎 <code>ObSql::stmt_query</code>（<code>src/sql/ob_sql.cpp:154</code>）/<code>handle_text_query</code>（<code>2799</code>）</li><li>→ 解析（<code>src/sql/parser/ob_parser.cpp:24</code>）→ 语义（<code>src/sql/resolver/ob_resolver.cpp:13</code>）→ 改写（<code>src/sql/rewrite/ob_transformer_impl.cpp:15</code>）→ 优化（<code>src/sql/optimizer/ob_optimizer.cpp:27</code>）→ 代码生成（<code>src/sql/code_generator/ob_code_generator.cpp:23</code>）</li><li>→ 执行（<code>ObTableScanOp::inner_open/get_next_row</code>）</li><li>→ DAS（<code>execute_das_task</code>）→ 位置服务（<code>get_leader</code>）→ 存储访问（<code>ObTableScanIterator</code>→<code>ObMemtable</code>/<code>ObSSTable</code>）</li><li>→ 返回结果集并编码为 MySQL 包。</li></ul><p>说明</p><ul><li>文中行号为便于设断点的“函数起始附近”位置，随版本可能轻微偏移；若不匹配，可先 <code>rg</code> 搜索函数名再下断点。</li></ul></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://zamaoxiaoji.github.io/>凝紫暮</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>